// DATABASE ----------------------------------------------

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// MODELS --------------------------------------------------

// Пользователь (покупатель)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  phone     String?
  name      String?
  createdAt DateTime @default(now())

  orders    Order[]
}

// Мероприятие (например: экскурсия, концерт, рейс теплохода)
model Event {
  id          String        @id @default(cuid())
  title       String
  startsAt    DateTime
  endsAt      DateTime?
  venueId     String?
  seatMapId   String?
  description String?
  imageUrl    String?

  ticketTypes TicketType[]
  seats       Seat[]
  prices      TicketPrice[]
  trips       Trip[]
  orders      Order[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// Рейс/Маршрут для водных прогулок
model Trip {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])

  boatName  String?
  startTime DateTime
  endTime   DateTime?

  orders    Order[]
}

// Типы билетов (входной, VIP, детский и т.п.)
model TicketType {
  id          String       @id @default(cuid())
  eventId     String
  code        String
  name        String
  description String?
  currency    String
  saleStarts  DateTime?
  saleEnds    DateTime?
  isActive    Boolean      @default(true)

  event       Event        @relation(fields: [eventId], references: [id])
  prices      TicketPrice[]
  orderItems  OrderItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([eventId])
  @@unique([eventId, code])
}

// Прайсы билетов по категориям/зонам
model TicketPrice {
  id             String       @id @default(cuid())
  eventId        String
  ticketTypeId   String
  seatCategoryId String?
  zone           String?
  amount         Decimal      @db.Decimal(10, 2)
  feeAmount      Decimal?     @db.Decimal(10, 2)
  currency       String
  isActive       Boolean      @default(true)

  event        Event          @relation(fields: [eventId], references: [id])
  ticketType   TicketType     @relation(fields: [ticketTypeId], references: [id])
  seatCategory SeatCategory?  @relation(fields: [seatCategoryId], references: [id])

  @@index([eventId])
  @@index([ticketTypeId])
  @@index([seatCategoryId])
}

// Категория мест (VIP, Economy и т.п.)
model SeatCategory {
  id    String @id @default(cuid())
  code  String
  name  String
  seats Seat[]

  @@unique([code])
}

// ------------------------------
// Схема мест и отдельные места
// ------------------------------
model SeatMap {
  id        Int      @id @default(autoincrement())
  eventId   String   @unique
  event     Event    @relation(fields: [eventId], references: [id])

  schemaJson Json

  seats     Seat[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Seat {
  id         String       @id @default(cuid())
  eventId    String
  externalId String
  label      String
  categoryId String?
  zone       String?
  isActive   Boolean      @default(true)

  seatMapId  Int?
  seatMap    SeatMap?     @relation(fields: [seatMapId], references: [id])
  row        String?
  section    String?
  priceZone  String?
  basePrice  Decimal?     @db.Decimal(10, 2)

  event      Event        @relation(fields: [eventId], references: [id])
  category   SeatCategory? @relation(fields: [categoryId], references: [id])
  locks      SeatLock[]
  orderItems OrderItem[]
  orderSeats OrderSeat[]

  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@unique([eventId, externalId])
  @@index([eventId])
  @@index([seatMapId])
  @@index([categoryId])
}

// ------------------------------
// Блокировка мест (для seatmap)
// ------------------------------
model SeatLock {
  id          String   @id @default(cuid())
  seatId      String
  eventId     String
  lockedUntil DateTime
  bySessionId String
  status      String

  seat        Seat     @relation(fields: [seatId], references: [id])
  event       Event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([seatId])
  @@index([lockedUntil])
}

model WaterSeatLock {
  id        String   @id @default(uuid())
  eventId   String
  seatCode  String
  sessionId String
  lockedAt  DateTime @default(now())
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([eventId])
  @@index([seatCode])
  @@index([expiresAt])
}

// Заказ
model Order {
  id            String       @id @default(uuid())
  userId        String?
  user          User?        @relation(fields: [userId], references: [id])

  eventId       String
  event         Event        @relation(fields: [eventId], references: [id])

  tripId        String?
  trip          Trip?        @relation(fields: [tripId], references: [id])

  status        OrderStatus  @default(PENDING)
  totalAmount   Decimal       @db.Decimal(10, 2)

  customerName  String?
  customerPhone String?
  customerEmail String?

  items         OrderItem[]
  payment       Payment?
  seats         OrderSeat[]

  createdAt     DateTime     @default(now())
}

model OrderSeat {
  id        Int      @id @default(autoincrement())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])

  seatId    String
  seat      Seat     @relation(fields: [seatId], references: [id])

  price     Decimal? @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([seatId])
}

// Позиции заказа — выбранные места или билеты
model OrderItem {
  id           String     @id @default(cuid())
  orderId      String
  order        Order      @relation(fields: [orderId], references: [id])

  eventId      String
  ticketTypeId String
  seatId       String?
  status       String
  priceAmount  Decimal    @db.Decimal(10, 2)
  currency     String

  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])
  seat         Seat?      @relation(fields: [seatId], references: [id])
  @@index([eventId])
  @@index([seatId])
}

// Платёж (YooKassa)
model Payment {
  id          String      @id @default(uuid())
  orderId     String      @unique
  order       Order       @relation(fields: [orderId], references: [id])

  provider    String      @default("yookassa")
  status      PaymentStatus
  externalId  String?
  amount      Decimal     @db.Decimal(10, 2)
  createdAt   DateTime    @default(now())
}

// ENUMS ----------------------------------------------------

enum OrderStatus {
  PENDING
  WAITING_FOR_PAYMENT
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  WAITING
  PAID
  FAILED
  CANCELED
}
