// DATABASE ----------------------------------------------

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// MODELS --------------------------------------------------

// Пользователь (покупатель)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  phone     String?
  name      String?
  createdAt DateTime @default(now())

  orders    Order[]
}

// Мероприятие (например: экскурсия, концерт, рейс теплохода)
model Event {
  id          Int           @id @default(autoincrement())
  title       String
  description String?
  date        DateTime
  imageUrl    String?

  // Схема сидений (если есть)
  seatPrices  SeatPrice[]
  ticketTypes TicketType[]
  trips       Trip[]
  seatMap     SeatMap?

  createdAt   DateTime      @default(now())
}

// Рейс/Маршрут для водных прогулок
model Trip {
  id        String   @id @default(uuid())
  eventId   Int
  event     Event    @relation(fields: [eventId], references: [id])

  boatName  String?
  startTime DateTime
  endTime   DateTime?

  orders    Order[]
}

// Типы билетов (входной, VIP, детский и т.п.)
model TicketType {
  id        String   @id @default(uuid())
  eventId   Int
  event     Event    @relation(fields: [eventId], references: [id])

  name      String
  price     Decimal  @db.Decimal(10, 2)

  createdAt DateTime @default(now())
}

// Цены по местам (seatmap)
model SeatPrice {
  id        String   @id @default(uuid())
  eventId   Int
  event     Event    @relation(fields: [eventId], references: [id])

  seatId    String      // напр. “A12” или “deck1-zone3-seat15”
  price     Decimal     @db.Decimal(10, 2)
  category  String?

  createdAt DateTime    @default(now())

  @@index([eventId])
  @@index([seatId])
}

// ------------------------------
// Схема мест и отдельные места
// ------------------------------
model SeatMap {
  id        Int      @id @default(autoincrement())
  eventId   Int      @unique
  event     Event    @relation(fields: [eventId], references: [id])

  schemaJson Json

  seats     Seat[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Seat {
  id         Int      @id @default(autoincrement())
  seatMapId  Int
  seatMap    SeatMap  @relation(fields: [seatMapId], references: [id])

  externalId String?
  label      String
  row        String?
  section    String?
  priceZone  String?
  basePrice  Decimal? @db.Decimal(10, 2)

  isActive   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seatMapId])
  @@index([externalId])
  @@index([section])
}

// ------------------------------
// Блокировка мест (для seatmap)
// ------------------------------
model SeatLock {
  id                Int      @id @default(autoincrement())
  eventId           Int
  seatId            Int
  seat              Seat     @relation(fields: [seatId], references: [id])
  sessionId         String
  expiresAt         DateTime
  externalBookingId String?

  createdAt DateTime @default(now())

  @@index([eventId])
  @@index([seatId])
  @@index([expiresAt])
}

model WaterSeatLock {
  id        String   @id @default(uuid())
  eventId   String
  seatCode  String
  sessionId String
  lockedAt  DateTime @default(now())
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([eventId])
  @@index([seatCode])
  @@index([expiresAt])
}

// Заказ
model Order {
  id          String       @id @default(uuid())
  userId      String?
  user        User?        @relation(fields: [userId], references: [id])

  eventId     Int
  event       Event        @relation(fields: [eventId], references: [id])

  tripId      String?
  trip        Trip?        @relation(fields: [tripId], references: [id])

  status      OrderStatus  @default(PENDING)
  totalAmount Decimal       @db.Decimal(10,2)

  customerName  String?
  customerPhone String?
  customerEmail String?

  items       OrderItem[]
  payment     Payment?
  seats       OrderSeat[]

  createdAt   DateTime @default(now())
}

model OrderSeat {
  id        Int      @id @default(autoincrement())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])

  seatId    Int
  seat      Seat     @relation(fields: [seatId], references: [id])

  price     Decimal? @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([seatId])
}

// Позиции заказа — выбранные места или билеты
model OrderItem {
  id         String     @id @default(uuid())
  orderId    String
  order      Order      @relation(fields: [orderId], references: [id])

  ticketTypeId String?
  ticketType   TicketType? @relation(fields: [ticketTypeId], references: [id])

  seatId     Int?
  price      Decimal    @db.Decimal(10, 2)

  createdAt  DateTime   @default(now())
}

// Платёж (YooKassa)
model Payment {
  id          String      @id @default(uuid())
  orderId     String      @unique
  order       Order       @relation(fields: [orderId], references: [id])

  provider    String      @default("yookassa")
  status      PaymentStatus
  externalId  String?     // ID в YooKassa
  amount      Decimal     @db.Decimal(10,2)
  createdAt   DateTime    @default(now())
}

// ENUMS ----------------------------------------------------

enum OrderStatus {
  PENDING
  WAITING_FOR_PAYMENT
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  WAITING
  PAID
  FAILED
  CANCELED
}
